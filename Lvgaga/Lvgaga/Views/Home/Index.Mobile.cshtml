@using LvService.Utilities
@model LvModel.View.Tumblr.TumblrsModel
@{
    ViewBag.Title = "首页";
}

<div>
    <div id="div_tumblrs">
        @foreach (var tumblr in Model.Tumblrs)
        {
            <div class="container-tumblr">
                <img class="img-tumblr lazy" data-original="@tumblr.MediaUri" alt="" />
                <div class="content">
                    <p class="text-tumblr">@tumblr.Text</p>
                    <p class="date-tumblr">@tumblr.CreateTime</p>
                    <button class="btn btn-default btn-favorite" rk="@tumblr.RowKey" tp="@tumblr.MediaType"><span class="glyphicon glyphicon-heart" aria-hidden="true"></span></button>
                    <button class="btn btn-default"><span class="glyphicon glyphicon-share-alt" aria-hidden="true"></span></button>
                    <a class="btn btn-default pull-right" href="@tumblr.Uri"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span></a>
                </div>
                <hr class="hr-tumblr" />
            </div>
        }
    </div>
    <div class="container-block">
        <button id="btn_load" type="button" class="btn btn-default btn-block">加载更多</button>
    </div>
</div>

@section scripts{
    @Scripts.Render("~/bundles/home")
    <script>
        (function() {
            var continuationToken = @Html.Raw(Model.ContinuationToken.ToJsonString());
            var sas = "@Html.Raw(Model.Sas)";
            var template = $(".container-tumblr:first").clone();

            $(function() {
                var divTumblrs = $("#div_tumblrs");

                $("img.lazy").lazyload({
                    effect: "fadeIn"
                });

                getFavoriteIndex("@ViewBag.MediaType", "@Model.Tumblrs.First().RowKey", "@Model.Tumblrs.Last().RowKey", function(data) {
                    $(".btn-favorite").each(function() {
                        var btnCur = $(this);
                        var rk = btnCur.attr("rk");
                        if (data[rk]) {
                            btnCur.addClass("btn-selected");
                        }
                    });
                });

                $(".btn-favorite").on("touchend", function(event) {
                    var btnCur = $(event.currentTarget);
                    if (!btnCur.hasClass("btn-selected")) {
                        favorite(btnCur.attr("tp"), btnCur.attr("rk"), btnCur);
                    } else {
                        unFavorite(btnCur.attr("tp"), btnCur.attr("rk"), btnCur);
                    }
                });

                $("#btn_load").on("touchend", function(event) {
                    queryTableWithPaging(sas, continuationToken, 20).done(function(data, textStatus, jqXHR) {
                        var last = $(".container-tumblr:last");
                        $.each(data.value, function(index, tumblr) {
                            var cp = template.clone();
                            cp.find("img.img-tumblr").attr("data-original", tumblr.MediaUri);
                            cp.appendTo(divTumblrs);
                        });
                        last.nextAll().find("img.lazy").lazyload({
                            effect: "fadeIn"
                        });

                        continuationToken.NextPartitionKey = jqXHR.getResponseHeader("x-ms-continuation-NextPartitionKey");
                        continuationToken.NextRowKey = jqXHR.getResponseHeader("x-ms-continuation-NextRowKey");
                    });
                });
            });
        })();
    </script>
}
