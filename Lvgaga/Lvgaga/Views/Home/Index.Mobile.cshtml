@using System.Text.RegularExpressions
@using LvService.Utilities
@model LvModel.View.Tumblr.TumblrsModel
@{
    ViewBag.Title = "首页";
}

<div>
    @foreach (var tumblr in Model.Tumblrs)
    {
        <div id="@tumblr.Id" class="container-tumblr" pk="@tumblr.PartitionKey" rk="@tumblr.RowKey">
            <img class="img-tumblr lazy" data-original="@tumblr.MediaUri" alt="" />
            <div class="content">
                <p class="text-tumblr">@tumblr.Text</p>
                <p class="date-tumblr">@tumblr.CreateTime</p>
                <button type="button" class="btn btn-default btn-favorite" pk="@tumblr.PartitionKey" rk="@tumblr.RowKey" tp="@tumblr.MediaType"><span class="glyphicon glyphicon-heart" aria-hidden="true"></span></button>
                <button type="button" class="btn btn-default"><span class="glyphicon glyphicon-share-alt" aria-hidden="true"></span></button>
                <a class="btn btn-default pull-right" href="@tumblr.Uri"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span></a>
            </div>
            <hr class="hr-tumblr" />
        </div>
    }
    <div class="container-block">
        <button type="button" class="btn btn-default btn-block">加载更多</button>
    </div>
</div>

@section scripts{
    @Scripts.Render("~/bundles/jquerylazy")
    @Scripts.Render("~/bundles/business")
    <script>
        (function () {
            var nextTableName = "@Model.ContinuationToken.NextTableName";
            var nextPartitionKey = "@Model.ContinuationToken.NextPartitionKey";
            var nextRowKey = "@Model.ContinuationToken.NextRowKey";

            $(function() {
                $("img.lazy").lazyload({
                    effect: "fadeIn"
                });

                getFavoriteIndex("@ViewBag.MediaType", "@Model.Tumblrs.First().RowKey", "@Model.Tumblrs.Last().RowKey", function(data) {
                    $(".btn-favorite").each(function() {
                        var btnCur = $(this);
                        var rk = btnCur.attr("rk");
                        if (data[rk]) {
                            btnCur.addClass("btn-selected");
                        }
                    });
                });

                $(".btn-favorite").on("touchend", function(event) {
                    var btnCur = $(event.currentTarget);
                    if (!btnCur.hasClass("btn-selected")) {
                        favorite(btnCur.attr("tp"), btnCur.attr("rk"), btnCur);
                    } else {
                        unFavorite(btnCur.attr("tp"), btnCur.attr("rk"), btnCur);
                    }
                });
            });
        })();
    </script>
}
